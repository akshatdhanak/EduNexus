{% extends "layout.html" %}
{% load custom_filters %}

{% block title %}Manage Exams{% endblock %}
{% block nav_title %}Manage Exams{% endblock %}

{% block style %}
:root{
  --bg:#f6f7fb;--card:#ffffff;--muted:#6b7280;--accent:#536dff;--accent-2:#7b5cff;--glass:rgba(255,255,255,0.6);
  --shadow-1: 0 6px 18px rgba(23,31,50,0.06);--shadow-2: 0 10px 30px rgba(17,24,39,0.08);
}
*{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto, Helvetica, Arial}
body{background:var(--bg)}
.exam-management-container{max-width:1250px;margin:0 auto;padding:28px}

/* Header / Hero */
.page-header{display:flex;align-items:center;justify-content:space-between;gap:18px;margin-bottom:28px}
.page-header > div{display:flex;flex-direction:column}
.page-header h1{font-size:28px;margin:0;color:#0f172a;font-weight:700}
.page-header .subtitle{color:var(--muted);margin-top:6px}
.btn-add-exam{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;padding:10px 16px;border-radius:12px;border:none;font-weight:600;box-shadow:var(--shadow-1);display:inline-flex;align-items:center;gap:10px}
.btn-add-exam:hover{transform:translateY(-4px);box-shadow:var(--shadow-2)}

/* Layout partitions */
.layout-row{display:grid;grid-template-columns:1fr 360px;gap:22px}

/* Left main column */
.main-col{display:flex;flex-direction:column;gap:22px}

/* Stats */
.stats-grid{display:flex;gap:18px}
.stat-card{flex:1;display:flex;align-items:center;gap:16px;background:linear-gradient(180deg,rgba(255,255,255,0.8),var(--card));padding:18px;border-radius:14px;box-shadow:var(--shadow-1)}
.stat-icon{width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff}
.stat-label{font-size:13px;color:var(--muted)}
.stat-value{font-size:28px;font-weight:700;color:#0f172a}

/* Semester section */
.semester-section{background:var(--card);border-radius:14px;padding:16px;box-shadow:var(--shadow-1);border:1px solid rgba(15,23,42,0.03)}
.semester-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.semester-header h2{font-size:18px;margin:0;color:#0f172a}
.exam-count{background:#eef2ff;color:#3b49d6;padding:6px 12px;border-radius:999px;font-weight:600}

/* Exam types grid */
.exam-types-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:14px}
.exam-type-card{background:linear-gradient(180deg,#fff,#fbfbff);border-radius:12px;padding:12px;border:1px solid rgba(99,102,241,0.06);box-shadow:0 6px 20px rgba(16,24,40,0.03);overflow:visible}
.exam-type-header{display:flex;align-items:center;justify-content:space-between;padding-bottom:8px;border-bottom:1px solid rgba(15,23,42,0.03)}
.exam-type-title{display:flex;align-items:center;gap:10px;font-weight:700;color:#0f172a}
.exam-badge{background:rgba(99,102,241,0.08);color:#3f3dd7;padding:6px 10px;border-radius:999px;font-weight:700}

.exam-list{padding-top:10px;display:flex;flex-direction:column;gap:10px}
.exam-item{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fbfdff,#ffffff);border:1px solid rgba(15,23,42,0.03);transition:transform 180ms ease,box-shadow 180ms ease}
.exam-item:hover{transform:translateY(-4px);box-shadow:var(--shadow-2)}
.exam-info{display:flex;flex-direction:column}
.exam-subject{font-weight:700;color:#0f172a}
.exam-marks{font-size:13px;color:var(--muted)}
.exam-actions{display:flex;align-items:center;gap:8px}
.btn-delete{background:#fff;border:1px solid rgba(15,23,42,0.06);padding:8px;border-radius:8px;cursor:pointer}
.btn-delete:hover{background:#fff3f3;border-color:#ff6b6b}

/* Empty state */
.empty-state{display:flex;flex-direction:column;align-items:center;padding:40px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfbff);box-shadow:var(--shadow-1)}

/* Modal improvements */
.modal{backdrop-filter:blur(4px)}
.modal-content{border-radius:14px;overflow:hidden}
.modal-header{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff}
.modal form{padding:20px}
.form-control{border-radius:8px;padding:10px 12px}
.modal-actions .btn-submit{border-radius:10px}

/* Responsive */
@media (max-width:980px){.layout-row{grid-template-columns:1fr}.stats-grid{flex-direction:column}.exam-types-grid{grid-template-columns:1fr}}
    transition: all 0.3s ease;
    font-size: 14px;
}

.btn-add-exam:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

/* Statistics */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.stat-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
}

.stat-label {
    font-size: 13px;
    color: #666;
    margin-bottom: 4px;
}

.stat-value {
    font-size: 28px;
    font-weight: 700;
    color: #1a1a1a;
}

/* Semester Sections */
.semester-section {
    margin-bottom: 40px;
}

.semester-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid #e0e0e0;
}

.semester-header h2 {
    font-size: 24px;
    font-weight: 600;
    color: #1a1a1a;
    margin: 0;
}

.exam-count {
    background: #f0f0f0;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
    color: #666;
}

/* Exam Type Cards */
.exam-types-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 20px;
}

.exam-type-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.exam-type-card.internal {
    border-top: 4px solid #1976d2;
}

.exam-type-card.external {
    border-top: 4px solid #7b1fa2;
}

.exam-type-card.practical {
    border-top: 4px solid #388e3c;
}

.exam-type-header {
    padding: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
}

.exam-type-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: #1a1a1a;
    font-size: 15px;
}

.exam-icon {
    font-size: 18px;
}

.exam-badge {
    background: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 600;
    color: #666;
}

.exam-list {
    padding: 12px;
}

.exam-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    margin-bottom: 8px;
    background: #f8f9fa;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.exam-item:hover {
    background: #e9ecef;
}

.exam-subject {
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 4px;
}

.exam-marks {
    font-size: 13px;
    color: #666;
}

.btn-delete {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 18px;
    opacity: 0.6;
    transition: all 0.2s ease;
}

.btn-delete:hover {
    opacity: 1;
    transform: scale(1.2);
}

.no-exams {
    text-align: center;
    padding: 24px;
    color: #999;
    font-size: 14px;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.empty-icon {
    font-size: 64px;
    margin-bottom: 16px;
}

.empty-state h3 {
    color: #1a1a1a;
    margin-bottom: 8px;
}

.empty-state p {
    color: #666;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid #e0e0e0;
}

.modal-header h3 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
}

.close {
    font-size: 28px;
    font-weight: 300;
    color: #999;
    cursor: pointer;
    transition: color 0.2s ease;
}

.close:hover {
    color: #333;
}

.modal form {
    padding: 24px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
    font-size: 14px;
}

.form-control {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.2s ease;
}

.form-control:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 24px;
}

.btn-cancel {
    padding: 10px 20px;
    background: #f0f0f0;
    color: #333;
    border: none;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s ease;
}

.btn-cancel:hover {
    background: #e0e0e0;
}

.btn-submit {
    padding: 10px 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-submit:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.exam-type-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
}

.exam-type-card {
    border: 1px solid #e4e7ec;
    border-radius: 10px;
    padding: 12px 14px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    background: #ffffff;
}

.exam-type-card input {
    display: none;
}

.exam-type-title {
    font-weight: 600;
    color: #1a1a1a;
    font-size: 14px;
}

.exam-type-desc {
    font-size: 12px;
    color: #667085;
}

.exam-type-card.selected {
    border-color: #5b6bff;
    box-shadow: 0 6px 16px rgba(91, 107, 255, 0.18);
    transform: translateY(-1px);
}

.exam-type-sessional {
    background: linear-gradient(135deg, #f5f7ff 0%, #eef0ff 100%);
}

.exam-type-external {
    background: linear-gradient(135deg, #fff4f0 0%, #ffe8e0 100%);
}

.exam-type-practical {
    background: linear-gradient(135deg, #f1fbff 0%, #e5f5ff 100%);
}

/* Alerts */
.alert {
    padding: 16px 20px;
    margin-bottom: 20px;
    border-radius: 8px;
    font-size: 14px;
}

.alert-success {
    background: #e8f5e9;
    color: #2e7d32;
    border-left: 4px solid #4caf50;
}

.alert-error {
    background: #ffebee;
    color: #c62828;
    border-left: 4px solid #f44336;
}
{% endblock %}

{% block container %}
<div class="exam-management-container">
    <div class="page-header">
        <div>
            <h1>Manage Exams</h1>
            <div class="subtitle">Create and review scheduled exams</div>
        </div>
        <div>
            <button class="btn-add-exam" onclick="showAddExamModal()">+ Add Exam</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üìö</div>
            <div>
                <div class="stat-label">Total Exams</div>
                <div class="stat-value">{{ total_exams }}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üìù</div>
            <div>
                <div class="stat-label">Marks Entered</div>
                <div class="stat-value">{{ total_marks_entered }}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üë•</div>
            <div>
                <div class="stat-label">Students</div>
                <div class="stat-value">{{ total_students }}</div>
            </div>
        </div>
    </div>

    <div class="layout-row">
        <div class="main-col">
            {% for sem in semesters %}
                <section class="semester-section">
                    <div class="semester-header">
                        <h2>Semester {{ sem }}</h2>
                        <div class="exam-count">{{ semester_counts|get_item:sem|get_item:'total' }}</div>
                    </div>

                    <div class="exam-types-grid">
                        {% with sem_dict=exams_by_semester|get_item:sem %}
                        {% for exam_type, exams_list in sem_dict.items %}
                            <div class="exam-type-card {{ exam_type|slugify }}">
                                <div class="exam-type-header">
                                    <div class="exam-type-title">{{ exam_type }}</div>
                                    <div class="exam-badge">{{ exams_list|length }}</div>
                                </div>
                                <div class="exam-list">
                                    {% for exam in exams_list %}
                                        <div class="exam-item">
                                            <div class="exam-info">
                                                <div class="exam-subject">{{ exam.subject.name }}</div>
                                                <div class="exam-marks">Max: {{ exam.max_marks }} ‚Ä¢ Passing: {{ exam.passing_marks }}</div>
                                            </div>
                                            <div class="exam-actions">
                                                <button class="btn-delete" onclick="deleteExam({{ exam.id }}, '{{ exam.subject.name|escapejs }}')">üóë</button>
                                            </div>
                                        </div>
                                    {% empty %}
                                        <div class="no-exams">No exams scheduled for this type.</div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                        {% endwith %}
                    </div>
                </section>
            {% empty %}
                <div class="empty-state">
                    <div class="empty-icon">üì≠</div>
                    <h3>No exams scheduled</h3>
                    <p>Use the Add Exam button to create the first exam.</p>
                </div>
            {% endfor %}
        </div>

        <aside>
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title">Quick Add Exam</h3>
                    <form method="post" action="{% url 'admin_app:add_exam' %}">
                        {% csrf_token %}
                        <div class="form-group">
                            <label>Semester</label>
                            <select id="examSemesterSelect" name="semester" class="form-control">
                                <option value="">Select semester</option>
                                {% for s in semester_range %}
                                    <option value="{{ s }}">{{ s }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Subject</label>
                            <select id="examSubjectSelect" name="subject" class="form-control">
                                <option value="">Select subject</option>
                                {% for subj in subjects %}
                                    <option value="{{ subj.id }}" data-semester="{{ subj.semester }}">{{ subj.name }}</option>
                                {% endfor %}
                            </select>
                            <div id="noExamSubjectsMsg" style="display:none;margin-top:8px;color:#999">No subjects for selected semester</div>
                        </div>

                        <div class="form-group">
                            <label>Exam Type</label>
                            <div class="exam-type-options">
                                {% for et in exam_types %}
                                    <label class="exam-type-card">
                                        <input type="radio" name="exam_type" value="{{ et.id }}"> <div class="exam-type-title">{{ et.name }}</div>
                                        <div class="exam-type-desc">{{ et.description }}</div>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Max Marks</label>
                            <input class="form-control" type="number" name="max_marks" value="100" />
                        </div>

                        <div class="form-group">
                            <label>Passing Marks</label>
                            <input class="form-control" type="number" name="passing_marks" value="40" />
                        </div>

                        <div class="modal-actions">
                            <button type="submit" class="btn-submit">Add Exam</button>
                        </div>
                    </form>
                </div>
            </div>
        </aside>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
function showAddExamModal() {
    document.getElementById('addExamModal').style.display = 'block';
}

function closeAddExamModal() {
    document.getElementById('addExamModal').style.display = 'none';
}

function deleteExam(examId, examName) {
    if (confirm(`Are you sure you want to delete "${examName}"?\n\nThis will also delete all marks entered for this exam.`)) {
        window.location.href = `/admin_app/admin_dashboard/manage_exams/${examId}/delete/`;
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('addExamModal');
    if (event.target == modal) {
        closeAddExamModal();
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const semesterSelect = document.getElementById('examSemesterSelect');
    const subjectSelect = document.getElementById('examSubjectSelect');
    const noSubjectsMsg = document.getElementById('noExamSubjectsMsg');
    const examTypeInputs = document.querySelectorAll('.exam-type-card input[type="radio"]');

    function filterExamSubjects() {
        if (!semesterSelect || !subjectSelect) {
            return;
        }

        const semester = semesterSelect.value;
        let hasVisible = false;

        Array.from(subjectSelect.options).forEach(function(option) {
            if (!option.value) {
                option.hidden = false;
                option.disabled = false;
                option.style.display = '';
                return;
            }

            const optionSem = option.getAttribute('data-semester');
            const shouldShow = semester && optionSem === String(semester);
            option.hidden = !shouldShow;
            option.disabled = !shouldShow;
            option.style.display = shouldShow ? '' : 'none';
            if (shouldShow) {
                hasVisible = true;
            }
        });

        subjectSelect.value = '';
        if (noSubjectsMsg) {
            noSubjectsMsg.style.display = hasVisible ? 'none' : 'block';
        }
    }

    function syncExamTypeCards() {
        examTypeInputs.forEach(function(input) {
            const card = input.closest('.exam-type-card');
            if (!card) {
                return;
            }
            card.classList.toggle('selected', input.checked);
        });
    }

    if (semesterSelect) {
        semesterSelect.addEventListener('change', filterExamSubjects);
    }

    examTypeInputs.forEach(function(input) {
        input.addEventListener('change', syncExamTypeCards);
    });

    filterExamSubjects();
    syncExamTypeCards();
});
</script>
{% endblock %}
