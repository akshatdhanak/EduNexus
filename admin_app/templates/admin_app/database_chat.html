{% extends 'layout.html' %}
{% block title %}AI Database Chat ‚Äî EduNexus{% endblock %}
{% block nav_title %}AI Database Assistant{% endblock %}
{% block style %} /* ============ Chat Container ============ */ .chat-wrapper {
max-width: 940px; margin: 0 auto; display: flex; flex-direction: column; height:
calc(100vh - 140px); } .chat-header { display: flex; align-items: center; gap:
14px; padding: 20px 0 16px; border-bottom: 1px solid #e8eaed; margin-bottom: 0;
} .chat-header-icon { width: 48px; height: 48px; background:
linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display:
flex; align-items: center; justify-content: center; } .chat-header-icon
.material-icons { color: #fff; font-size: 26px; } .chat-header-text h1 {
font-size: 20px; font-weight: 500; margin: 0; color: #202124; }
.chat-header-text p { font-size: 13px; color: #5f6368; margin: 2px 0 0; }
.chat-header-actions { margin-left: auto; display: flex; gap: 8px; } .header-btn
{ padding: 6px 14px; border-radius: 20px; border: 1px solid #dadce0; background:
#fff; color: #5f6368; cursor: pointer; font-size: 12px; font-family: inherit;
transition: all 0.2s; display: flex; align-items: center; gap: 4px; }
.header-btn:hover { background: #f1f3f4; border-color: #1a73e8; color: #1a73e8;
} /* ============ Messages ============ */ .chat-messages { flex: 1; overflow-y:
auto; padding: 20px 0; display: flex; flex-direction: column; gap: 16px;
scroll-behavior: smooth; } .chat-messages::-webkit-scrollbar { width: 6px; }
.chat-messages::-webkit-scrollbar-track { background: transparent; }
.chat-messages::-webkit-scrollbar-thumb { background: #dadce0; border-radius:
3px; } /* ============ Message Bubbles ============ */ .msg { display: flex;
gap: 12px; max-width: 88%; animation: msgIn 0.3s ease-out; } @keyframes msgIn {
from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform:
translateY(0); } } .msg-user { align-self: flex-end; flex-direction:
row-reverse; } .msg-avatar { width: 34px; height: 34px; border-radius: 50%;
display: flex; align-items: center; justify-content: center; flex-shrink: 0;
font-size: 16px; } .msg-bot .msg-avatar { background: linear-gradient(135deg,
#667eea, #764ba2); color: #fff; } .msg-user .msg-avatar { background: #1a73e8;
color: #fff; } .msg-bubble { padding: 14px 18px; border-radius: 18px; font-size:
14px; line-height: 1.6; word-break: break-word; } .msg-bot .msg-bubble {
background: #f1f3f4; color: #202124; border-bottom-left-radius: 6px; } .msg-user
.msg-bubble { background: #1a73e8; color: #fff; border-bottom-right-radius: 6px;
} .msg-bot .msg-bubble strong { font-weight: 600; color: #202124; } .msg-bot
.msg-bubble em { color: #5f6368; } .msg-bot .msg-bubble code { background:
#e8eaed; padding: 2px 6px; border-radius: 4px; font-size: 12px; } /*
============ Tables ============ */ .chat-table-wrap { margin-top: 10px;
overflow-x: auto; border-radius: 8px; border: 1px solid #e8eaed; }
.chat-table-wrap table { margin: 0; box-shadow: none; border-radius: 0;
font-size: 13px; min-width: 100%; border-collapse: collapse; } .chat-table-wrap
th { background: #e8eaed; font-size: 12px; padding: 10px 14px; white-space:
nowrap; color: #3c4043; font-weight: 600; text-transform: uppercase;
letter-spacing: 0.5px; } .chat-table-wrap td { padding: 8px 14px; font-size:
13px; border-bottom: 1px solid #f1f3f4; white-space: nowrap; } .chat-table-wrap
tr:last-child td { border-bottom: none; } .chat-table-wrap tr:hover {
background: #f8f9fa; } .table-title { font-size: 15px; font-weight: 500;
margin-bottom: 8px; color: #202124; } /* ============ Charts ============ */
.chart-container { margin-top: 12px; background: #fff; border-radius: 12px;
border: 1px solid #e8eaed; padding: 16px; max-width: 600px; } .chart-container
canvas { max-height: 300px; } /* ============ AI Query Badge ============ */
.ai-query-badge { margin-top: 8px; padding: 8px 12px; background: #f8f9fa;
border-radius: 8px; border: 1px solid #e8eaed; font-size: 11px; color: #5f6368;
font-family: monospace; white-space: pre-wrap; max-height: 60px; overflow:
hidden; cursor: pointer; transition: max-height 0.3s ease; }
.ai-query-badge.expanded { max-height: 400px; } .ai-query-badge-label {
font-family: inherit; color: #1a73e8; font-weight: 600; } /* ============
Suggestion Chips ============ */ .suggestion-chips { display: flex; flex-wrap:
wrap; gap: 6px; margin-top: 10px; } .suggestion-chip { padding: 6px 14px;
background: #fff; border: 1px solid #dadce0; border-radius: 18px; font-size:
12px; color: #1a73e8; cursor: pointer; transition: all 0.2s; font-family:
inherit; white-space: nowrap; } .suggestion-chip:hover { background: #e8f0fe;
border-color: #1a73e8; } /* ============ Typing Indicator ============ */
.typing-indicator { display: none; align-items: center; gap: 12px; max-width:
85%; } .typing-indicator.active { display: flex; } .typing-dots { display: flex;
gap: 4px; padding: 14px 18px; background: #f1f3f4; border-radius: 18px;
border-bottom-left-radius: 6px; } .typing-dots span { width: 8px; height: 8px;
background: #80868b; border-radius: 50%; animation: typing 1.4s infinite; }
.typing-dots span:nth-child(2) { animation-delay: 0.2s; } .typing-dots
span:nth-child(3) { animation-delay: 0.4s; } @keyframes typing { 0%, 100% {
opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1); }
} /* ============ Input ============ */ .chat-input-area { padding: 16px 0 8px;
border-top: 1px solid #e8eaed; } .chat-input-wrap { display: flex; align-items:
center; gap: 10px; background: #fff; border: 2px solid #e8eaed; border-radius:
28px; padding: 6px 8px 6px 20px; transition: border-color 0.2s; }
.chat-input-wrap:focus-within { border-color: #1a73e8; box-shadow: 0 1px 6px
rgba(26,115,232,0.15); } .chat-input-wrap input { flex: 1; border: none;
outline: none; font-size: 15px; font-family: inherit; color: #202124;
background: transparent; padding: 10px 0; } .chat-input-wrap input::placeholder
{ color: #9aa0a6; } .chat-send-btn { width: 42px; height: 42px; border-radius:
50%; border: none; background: #1a73e8; color: #fff; cursor: pointer; display:
flex; align-items: center; justify-content: center; transition: all 0.2s;
flex-shrink: 0; } .chat-send-btn:hover { background: #1765cc; box-shadow: 0 2px
8px rgba(26,115,232,0.3); } .chat-send-btn:disabled { background: #dadce0;
cursor: not-allowed; box-shadow: none; } .chat-send-btn .material-icons {
font-size: 22px; } /* ============ Quick Actions ============ */ .quick-actions
{ display: flex; flex-wrap: wrap; gap: 8px; padding: 8px 0; } .quick-chip {
padding: 8px 16px; background: #fff; border: 1px solid #dadce0; border-radius:
20px; font-size: 13px; color: #1a73e8; cursor: pointer; transition: all 0.2s;
font-family: inherit; white-space: nowrap; } .quick-chip:hover { background:
#e8f0fe; border-color: #1a73e8; } /* ============ Welcome Card ============ */
.welcome-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
border-radius: 16px; padding: 28px; color: #fff; margin-bottom: 16px; }
.welcome-card h2 { color: #fff; font-size: 22px; font-weight: 500;
margin-bottom: 8px; } .welcome-card p { color: rgba(255,255,255,0.85);
font-size: 14px; margin: 0; line-height: 1.5; } .welcome-features { display:
grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 14px; }
.welcome-feature { background: rgba(255,255,255,0.15); border-radius: 10px;
padding: 10px 14px; font-size: 13px; color: rgba(255,255,255,0.95); display:
flex; align-items: center; gap: 8px; } .welcome-feature .material-icons {
font-size: 18px; } /* ============ Export Button ============ */ .export-btn {
display: inline-flex; align-items: center; gap: 4px; margin-top: 6px; padding:
4px 10px; border-radius: 6px; border: 1px solid #dadce0; background: #fff;
color: #5f6368; font-size: 11px; cursor: pointer; font-family: inherit; }
.export-btn:hover { background: #e8f0fe; color: #1a73e8; }
{% endblock %}
{% block container %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<div class="chat-wrapper">
  <!-- Header -->
  <div class="chat-header">
    <div class="chat-header-icon">
      <span class="material-icons">psychology</span>
    </div>
    <div class="chat-header-text">
      <h1>AI Database Assistant</h1>
      <p>
        Powered by Google Gemini ‚Äî ask anything about the EduNexus database in
        plain English
      </p>
    </div>
    <div class="chat-header-actions">
      <button
        class="header-btn"
        onclick="clearChat()"
        title="Clear conversation"
      >
        <span class="material-icons" style="font-size: 16px"
          >delete_outline</span
        >
        Clear
      </button>
      <button
        class="header-btn"
        onclick="exportChat()"
        title="Export conversation"
      >
        <span class="material-icons" style="font-size: 16px">download</span>
        Export
      </button>
    </div>
  </div>

  <!-- Messages -->
  <div class="chat-messages" id="chatMessages">
    <!-- Welcome -->
    <div class="msg msg-bot">
      <div class="msg-avatar">
        <span class="material-icons" style="font-size: 18px">psychology</span>
      </div>
      <div>
        <div class="welcome-card">
          <h2>üß† AI-Powered Database Assistant</h2>
          <p>
            I use Google Gemini AI to understand your questions, automatically
            generate database queries, and explain results in plain English.
          </p>
          <div class="welcome-features">
            <div class="welcome-feature">
              <span class="material-icons">schema</span> Schema-aware queries
            </div>
            <div class="welcome-feature">
              <span class="material-icons">chat</span> Follow-up questions
            </div>
            <div class="welcome-feature">
              <span class="material-icons">bar_chart</span> Charts &amp; tables
            </div>
            <div class="welcome-feature">
              <span class="material-icons">security</span> Read-only &amp; safe
            </div>
          </div>
        </div>
        <div class="quick-actions">
          <button
            class="quick-chip"
            onclick="sendQuick('How many students are enrolled?')"
          >
            üéì Count Students
          </button>
          <button
            class="quick-chip"
            onclick="sendQuick('Show database statistics')"
          >
            üìà Statistics
          </button>
          <button
            class="quick-chip"
            onclick="sendQuick('List all departments')"
          >
            üèõ Departments
          </button>
          <button
            class="quick-chip"
            onclick="sendQuick('Show students per semester as a chart')"
          >
            üìä Semester Chart
          </button>
          <button
            class="quick-chip"
            onclick="sendQuick('Show attendance statistics')"
          >
            üìã Attendance
          </button>
          <button
            class="quick-chip"
            onclick="sendQuick('Show exam results summary')"
          >
            üìù Results
          </button>
          <button
            class="quick-chip"
            onclick="sendQuick('Fee collection overview')"
          >
            üí∞ Fees
          </button>
          <button
            class="quick-chip"
            onclick="sendQuick('Who are the faculty members?')"
          >
            üë®‚Äçüè´ Faculty
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Typing -->
  <div class="typing-indicator" id="typingIndicator">
    <div
      class="msg-avatar"
      style="
        background: linear-gradient(135deg, #667eea, #764ba2);
        width: 34px;
        height: 34px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      "
    >
      <span class="material-icons" style="color: #fff; font-size: 18px"
        >psychology</span
      >
    </div>
    <div class="typing-dots"><span></span><span></span><span></span></div>
  </div>

  <!-- Input -->
  <div class="chat-input-area">
    <form id="chatForm" onsubmit="return sendMessage(event);">
      <div class="chat-input-wrap">
        <input
          type="text"
          id="chatInput"
          placeholder="Ask anything about the database in plain English..."
          autocomplete="off"
        />
        <button type="submit" class="chat-send-btn" id="sendBtn">
          <span class="material-icons">send</span>
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  const chatMessages = document.getElementById("chatMessages");
  const chatInput = document.getElementById("chatInput");
  const sendBtn = document.getElementById("sendBtn");
  const typingIndicator = document.getElementById("typingIndicator");
  let chartCounter = 0;

  function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function escapeHtml(text) {
    const el = document.createElement("span");
    el.textContent = text;
    return el.innerHTML;
  }

  function formatMessage(text) {
    let msg = escapeHtml(text);
    // Code blocks
    msg = msg.replace(
      /```([\s\S]*?)```/g,
      '<pre style="background:#e8eaed;padding:10px;border-radius:8px;font-size:12px;overflow-x:auto;margin:8px 0">$1</pre>',
    );
    // Inline code
    msg = msg.replace(/`([^`]+)`/g, "<code>$1</code>");
    // Bold
    msg = msg.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
    // Italic
    msg = msg.replace(/\*(.*?)\*/g, "<em>$1</em>");
    // Line breaks
    msg = msg.replace(/\n/g, "<br>");
    // Bullet points
    msg = msg.replace(/‚Ä¢ /g, "&bull; ");
    return msg;
  }

  function addUserMessage(text) {
    const div = document.createElement("div");
    div.className = "msg msg-user";
    div.innerHTML = `
        <div class="msg-avatar"><span class="material-icons" style="font-size:16px">person</span></div>
        <div class="msg-bubble">${escapeHtml(text)}</div>
    `;
    chatMessages.appendChild(div);
    scrollToBottom();
  }

  function addBotMessage(data) {
    const div = document.createElement("div");
    div.className = "msg msg-bot";
    let content = "";

    // Text message
    if (data.message) {
      content += `<div class="msg-bubble">${formatMessage(data.message)}</div>`;
    }

    // AI query badge
    if (data._ai && data._ai.query) {
      content += `<div class="ai-query-badge" onclick="this.classList.toggle('expanded')" title="Click to expand/collapse">
            <span class="ai-query-badge-label">üß† AI Query:</span> ${escapeHtml(data._ai.query)}
        </div>`;
    }

    // Table
    if (
      (data.type === "table" || data.type === "chart") &&
      data.rows &&
      data.rows.length > 0
    ) {
      let tableHtml = "";
      if (data.title)
        tableHtml += `<div class="table-title">${escapeHtml(data.title)}</div>`;
      tableHtml += '<div class="chat-table-wrap"><table><thead><tr>';
      for (const col of data.columns || []) {
        tableHtml += `<th>${escapeHtml(String(col))}</th>`;
      }
      tableHtml += "</tr></thead><tbody>";
      for (const row of data.rows) {
        tableHtml += "<tr>";
        for (const cell of row) {
          tableHtml += `<td>${escapeHtml(String(cell))}</td>`;
        }
        tableHtml += "</tr>";
      }
      tableHtml += "</tbody></table></div>";
      // Export button for tables
      const tableId = "table_" + Date.now();
      tableHtml += `<button class="export-btn" onclick="exportTable('${tableId}')">
            <span class="material-icons" style="font-size:14px">download</span> Export CSV
        </button>`;
      content += `<div id="${tableId}" data-columns='${JSON.stringify(data.columns || [])}' data-rows='${JSON.stringify(data.rows || [])}'>${tableHtml}</div>`;
    }

    // Chart
    if (
      data.type === "chart" &&
      data.chart_data &&
      data.chart_data.labels &&
      data.chart_data.labels.length > 0
    ) {
      chartCounter++;
      const canvasId = "chart_" + chartCounter;
      content += `<div class="chart-container"><canvas id="${canvasId}"></canvas></div>`;
      // Render chart after DOM update
      setTimeout(() => {
        const ctx = document.getElementById(canvasId);
        if (ctx) {
          const chartType = data.chart_type || "bar";
          const colors = [
            "#667eea",
            "#764ba2",
            "#1a73e8",
            "#34a853",
            "#fbbc04",
            "#ea4335",
            "#4285f4",
            "#0f9d58",
            "#f4b400",
            "#db4437",
            "#673ab7",
            "#00bcd4",
            "#ff5722",
            "#795548",
          ];
          new Chart(ctx, {
            type: chartType,
            data: {
              labels: data.chart_data.labels,
              datasets: [
                {
                  label: data.title || "Data",
                  data: data.chart_data.values,
                  backgroundColor:
                    chartType === "pie" || chartType === "doughnut"
                      ? colors.slice(0, data.chart_data.labels.length)
                      : "#667eea",
                  borderColor: chartType === "line" ? "#667eea" : undefined,
                  borderWidth: chartType === "line" ? 2 : 1,
                  borderRadius: chartType === "bar" ? 6 : 0,
                  fill: chartType === "line" ? false : undefined,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  display: chartType === "pie" || chartType === "doughnut",
                },
              },
              scales:
                chartType !== "pie" && chartType !== "doughnut"
                  ? {
                      y: { beginAtZero: true, grid: { color: "#f1f3f4" } },
                      x: { grid: { display: false } },
                    }
                  : undefined,
            },
          });
        }
      }, 100);
    }

    // Suggestions
    if (data.suggestions && data.suggestions.length > 0) {
      content += '<div class="suggestion-chips">';
      for (const s of data.suggestions) {
        content += `<button class="suggestion-chip" onclick="sendQuick('${escapeHtml(s)}')">${escapeHtml(s)}</button>`;
      }
      content += "</div>";
    }

    div.innerHTML = `
        <div class="msg-avatar"><span class="material-icons" style="font-size:18px">psychology</span></div>
        <div style="flex:1;min-width:0">${content}</div>
    `;
    chatMessages.appendChild(div);
    scrollToBottom();
  }

  function showTyping() {
    typingIndicator.classList.add("active");
    scrollToBottom();
  }
  function hideTyping() {
    typingIndicator.classList.remove("active");
  }

  function sendQuick(text) {
    chatInput.value = text;
    sendMessage(new Event("submit"));
  }

  async function sendMessage(e) {
    e.preventDefault();
    const text = chatInput.value.trim();
    if (!text) return;

    addUserMessage(text);
    chatInput.value = "";
    sendBtn.disabled = true;
    showTyping();

    try {
      const response = await fetch("{% url 'admin_app:chat_api' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({ message: text }),
      });
      const data = await response.json();
      hideTyping();
      addBotMessage(data);
    } catch (err) {
      hideTyping();
      addBotMessage({
        type: "text",
        message: "‚ùå Something went wrong. Please try again.",
      });
    }

    sendBtn.disabled = false;
    chatInput.focus();
    return false;
  }

  async function clearChat() {
    try {
      await fetch("{% url 'admin_app:chat_clear' %}", {
        method: "POST",
        headers: { "X-CSRFToken": getCookie("csrftoken") },
      });
    } catch (e) {
      /* ignore */
    }

    // Keep welcome message, remove rest
    const msgs = chatMessages.querySelectorAll(".msg");
    msgs.forEach((m, i) => {
      if (i > 0) m.remove();
    });
  }

  function exportTable(tableId) {
    const el = document.getElementById(tableId);
    if (!el) return;
    const columns = JSON.parse(el.dataset.columns || "[]");
    const rows = JSON.parse(el.dataset.rows || "[]");

    let csv = columns.join(",") + "\n";
    for (const row of rows) {
      csv +=
        row.map((c) => `"${String(c).replace(/"/g, '""')}"`).join(",") + "\n";
    }

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "edunexus_query_result.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  function exportChat() {
    const msgs = chatMessages.querySelectorAll(".msg");
    let text = "EduNexus AI Chat Export\n" + "=".repeat(40) + "\n\n";
    msgs.forEach((m) => {
      const isUser = m.classList.contains("msg-user");
      const bubble = m.querySelector(".msg-bubble");
      if (bubble) {
        text +=
          (isUser ? "You: " : "AI: ") + bubble.textContent.trim() + "\n\n";
      }
    });
    const blob = new Blob([text], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "edunexus_chat_export.txt";
    a.click();
    URL.revokeObjectURL(url);
  }

  function getCookie(name) {
    let value = null;
    document.cookie.split(";").forEach((c) => {
      c = c.trim();
      if (c.startsWith(name + "=")) {
        value = decodeURIComponent(c.substring(name.length + 1));
      }
    });
    return value;
  }

  // Focus + Enter-to-send
  chatInput.focus();
  chatInput.addEventListener("keydown", function (e) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      document.getElementById("chatForm").dispatchEvent(new Event("submit"));
    }
  });
</script>
{% endblock %}
